<!DOCTYPE html>
<html lang="ur">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <title>‚ù§Ô∏è Ahad & Amna - Dashboard</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        :root { --primary: #667eea; --secondary: #764ba2; --success: #2ecc71; --danger: #e74c3c; }

        html, body {
            font-family: 'Poppins', sans-serif;
            background: #f0f2f5;
            height: 100%;
            height: 100dvh; 
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: fixed;
            width: 100%;
            top: 0;
            left: 0;
        }

        /* HEADER (Fixed Top) */
        .header {
            flex: 0 0 auto;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 100;
            height: 60px;
        }

        .header-left { display: flex; align-items: center; gap: 10px; }
        .partner-avatar { width: 40px; height: 40px; border-radius: 50%; background: white; display: flex; align-items: center; justify-content: center; font-size: 20px; position: relative; }
        .online-indicator { position: absolute; bottom: 0; right: 0; width: 10px; height: 10px; background: var(--success); border-radius: 50%; border: 2px solid white; }
        .online-indicator.offline { background: #95a5a6; }
        .partner-details h3 { font-size: 15px; font-weight: 600; margin: 0; }
        .partner-status { font-size: 11px; opacity: 0.9; }

        .icon-btn { width: 35px; height: 35px; border-radius: 50%; border: none; background: rgba(255,255,255,0.2); color: white; font-size: 18px; cursor: pointer; margin-left: 5px; }

        /* MAIN CONTAINER */
        .main-container {
            flex: 1;
            display: flex;
            position: relative;
            overflow: hidden;
            height: calc(100% - 60px);
        }

        /* CHAT SECTION */
        .chat-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            position: relative;
            background: white;
            overflow: hidden;
        }

        /* MESSAGES - SCROLLABLE AREA */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 15px;
            padding-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: #f4f4f9;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            position: relative;
            /* IMPORTANT: Height calculation */
            max-height: 100%;
        }

        /* Force scrollbar visible */
        .messages-container::-webkit-scrollbar {
            width: 6px;
        }
        .messages-container::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .messages-container::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 3px;
        }

        .message { 
            max-width: 80%; 
            padding: 10px 15px; 
            border-radius: 15px; 
            font-size: 14px; 
            word-wrap: break-word; 
            word-break: break-word;
            position: relative; 
            animation: slideIn 0.2s ease; 
            flex-shrink: 0;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .message.sent { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 2px; }
        .message.received { align-self: flex-start; background: white; color: #333; border: 1px solid #ddd; border-bottom-left-radius: 2px; }
        .message-time { font-size: 9px; opacity: 0.7; text-align: right; margin-top: 2px; }

        /* INPUT AREA (Fixed Bottom) */
        .input-area {
            flex: 0 0 auto;
            padding: 10px;
            background: white;
            border-top: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
            z-index: 10;
        }

        .input-wrapper { flex: 1; position: relative; }
        .message-input { width: 100%; padding: 12px 40px 12px 15px; border: 1px solid #ddd; border-radius: 25px; outline: none; font-size: 15px; background: #f9f9f9; }
        .message-input:focus { border-color: var(--primary); background: white; }
        
        .heart-btn { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; font-size: 20px; cursor: pointer; }
        .send-btn { width: 45px; height: 45px; border-radius: 50%; background: var(--primary); color: white; border: none; font-size: 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); cursor: pointer; }

        /* Mobile fixes */
        @media (max-width: 768px) {
            .messages-container {
                -webkit-overflow-scrolling: touch;
                overscroll-behavior-y: contain;
            }
        }
    </style>
</head>
<body>

    <header class="header">
        <div class="header-left">
            <div class="partner-avatar">
                <span id="partnerAvatar">üë©</span>
                <div class="online-indicator" id="onlineIndicator"></div>
            </div>
            <div class="partner-details">
                <h3 id="partnerName">Partner</h3>
                <div class="partner-status" id="lastSeen">Loading...</div>
            </div>
        </div>
        <div>
            <button class="icon-btn" onclick="logout()">üö™</button>
        </div>
    </header>

    <div class="main-container">
        <div class="chat-section">
            <div class="messages-container" id="messagesContainer">
                <!-- Messages yahan aayenge -->
            </div>
            
            <div class="input-area">
                <div class="input-wrapper">
                    <input type="text" class="message-input" id="messageInput" placeholder="Message..." autocomplete="off">
                    <button class="heart-btn" onclick="sendHeart()">‚ù§Ô∏è</button>
                </div>
                <button class="send-btn" onclick="sendMessage()">‚û§</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // üî• TERA CONFIG
        const firebaseConfig = {
          apiKey: "AIzaSyD9izkgUqK9kmxiUd2lsdpgs5Krpkve68E",
          authDomain: "mychattapp-a5fcc.firebaseapp.com",
          databaseURL: "https://mychattapp-a5fcc-default-rtdb.firebaseio.com",
          projectId: "mychattapp-a5fcc",
          storageBucket: "mychattapp-a5fcc.firebasestorage.app",
          messagingSenderId: "265732110927",
          appId: "1:265732110927:web:de60478c1303bca701083a"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Check Login
        const currentUser = localStorage.getItem('currentUser');
        if (!currentUser) window.location.href = 'index.html';

        // Setup Variables
        const partner = currentUser === 'ahad' ? 'amna' : 'ahad';
        const partnerName = currentUser === 'ahad' ? 'Amna' : 'Ahad';
        const avatar = currentUser === 'ahad' ? 'üë©' : 'üë®';

        document.getElementById('partnerName').innerText = partnerName;
        document.getElementById('partnerAvatar').innerText = avatar;

        // Presence System
        const myStatus = db.ref('users/' + currentUser);
        myStatus.onDisconnect().update({ online: false, lastSeen: firebase.database.ServerValue.TIMESTAMP });
        myStatus.update({ online: true });

        db.ref('users/' + partner).on('value', snap => {
            const val = snap.val();
            const ind = document.getElementById('onlineIndicator');
            const txt = document.getElementById('lastSeen');
            
            if (val && val.online) {
                ind.classList.remove('offline');
                txt.innerText = "Online";
                txt.style.color = "#81ef9d";
            } else {
                ind.classList.add('offline');
                txt.innerText = "Offline";
                txt.style.color = "rgba(255,255,255,0.8)";
            }
        });

        // Chat System
        const messagesRef = db.ref('messages');
        const container = document.getElementById('messagesContainer');

        // ‚úÖ FIXED: Better scroll function
        function scrollToBottom() {
            setTimeout(() => {
                container.scrollTo({
                    top: container.scrollHeight,
                    behavior: 'smooth'
                });
                // Fallback for older browsers
                container.scrollTop = container.scrollHeight;
            }, 50);
        }

        // ‚úÖ FIXED: Force scroll on load
        window.onload = function() {
            setTimeout(scrollToBottom, 500);
        };

        // ‚úÖ FIXED: Touch scroll for mobile
        let touchStartY = 0;
        container.addEventListener('touchstart', function(e) {
            touchStartY = e.touches[0].clientY;
        }, { passive: true });

        container.addEventListener('touchmove', function(e) {
            // Allow default scrolling
        }, { passive: true });

        // Send Message
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            if (!text) return;

            messagesRef.push({
                sender: currentUser,
                text: text,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            input.value = "";
            input.focus();
            scrollToBottom();
        }

        function sendHeart() {
            messagesRef.push({ 
                sender: currentUser, 
                text: "‚ù§Ô∏è", 
                timestamp: firebase.database.ServerValue.TIMESTAMP 
            });
            scrollToBottom();
        }

        // ‚úÖ FIXED: Receive Messages with forced scroll
        messagesRef.on('child_added', snap => {
            const msg = snap.val();
            const div = document.createElement('div');
            const isMe = msg.sender === currentUser;
            div.className = `message ${isMe ? 'sent' : 'received'}`;
            
            const date = new Date(msg.timestamp);
            const timeStr = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

            div.innerHTML = `
                ${escapeHtml(msg.text)}
                <div class="message-time">${timeStr}</div>
            `;
            
            container.appendChild(div);
            
            // ‚úÖ Auto scroll hamesha bottom pe
            scrollToBottom();
            
            // ‚úÖ Vibration for new message
            if (!isMe && navigator.vibrate) {
                navigator.vibrate([50, 50]);
            }
        });

        // ‚úÖ Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Enter key support
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') sendMessage();
        });

        // Logout
        window.logout = function() {
            myStatus.update({ online: false });
            localStorage.clear();
            window.location.href = 'index.html';
        }

        // ‚úÖ Keep online status updated
        setInterval(() => {
            myStatus.update({ online: true });
        }, 30000);
    </script>
</body>
</html>
